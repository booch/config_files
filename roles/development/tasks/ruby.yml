---

- name: Install chruby
  homebrew:
    name: chruby
  notify:
    - Load chruby

- name: See if we've enabled chruby in its own profile.d file
  stat:
    path: ~/.profile.d/chruby.sh
  register: profile_d_chruby

- name: Ensure chruby is available in Bash (unless it's in its own profile.d file)
  lineinfile:
    dest: ~/.bash_profile
    line: source {{ homebrew_dir }}/share/chruby/chruby.sh
    regexp: '\s*source {{ homebrew_dir }}/share/chruby/chruby.sh'
  when: profile_d_chruby.stat.exists == False

- name: Enable chruby to automatically use `.ruby-version` when changing directories in Bash (unless it's in its own profile.d file)
  lineinfile:
    dest: ~/.bash_profile
    line: source {{ homebrew_dir }}/share/chruby/auto.sh
    regexp: '\s*source {{ homebrew_dir }}/share/chruby/auto.sh'
  when: profile_d_chruby.stat.exists == False

- name: Install ruby-install
  homebrew:
    name: ruby-install

# NOTE: It will take several minutes to compile each version of Ruby.
- name: Install Ruby
  include: ruby_install.yml
  vars:
    engine: "{{ item.engine }}"
    version: "{{ item.version }}"
    sha256: "{{ item.sha256 }}"
  with_items: "{{ ruby_versions }}"
  notify:
    - Load chruby

- name: Install common Ruby gems for all versions of Ruby
  include: gem_install.yml
  vars:
    ruby_engine: "{{ item[0].engine }}"
    ruby_version: "{{ item[0].version }}"
    gem: "{{ item[1] }}"
  with_nested:
    - "{{ ruby_versions }}"
    - "{{ gems_for_all_rubies }}"

# NOTE: Other tasks may install other versions of Ruby
- name: Install Ruby gems for latest version of Ruby
  include: gem_install.yml
  vars:
    ruby_engine: "{{ ruby_versions[0].engine }}"
    ruby_version: "{{ ruby_versions[0].version }}"
    gem: "{{ item }}"
  with_items:
    - "{{ gems_for_latest_ruby }}"

- name: Ensure bundled gems are installed locally to each app
  lineinfile:
    dest: ~/.bash_profile
    line: export BUNDLE_PATH=vendor/bundle

- name: Install Bash completion for Ruby tools
  homebrew:
    name:
      - ruby-completion
      - bundler-completion
      - gem-completion
      - rake-completion
      - rails-completion
      - cap-completion # Capistrano
